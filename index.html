<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TravelEase - Complete Travel & Cab Booking Platform</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        :root {
            --primary: #2d5be3;
            --secondary: #ff9d00;
            --light: #f8f9fa;
            --dark: #343a40;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
        }

        body {
            background-color: #f5f7ff;
            color: #333;
            line-height: 1.6;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }

        /* Header Styles */
        header {
            background: linear-gradient(135deg, var(--primary), #1a3fc7);
            color: white;
            padding: 15px 0;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.8rem;
            font-weight: 700;
            text-decoration: none;
            color: white;
        }

        .logo i {
            color: var(--secondary);
        }

        nav ul {
            display: flex;
            list-style: none;
            gap: 25px;
        }

        nav a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
            font-size: 1.1rem;
        }

        nav a:hover {
            color: var(--secondary);
        }

        .user-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 5px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--secondary);
            color: white;
        }

        .btn-primary:hover {
            background-color: #e88e00;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 157, 0, 0.3);
        }

        .btn-outline {
            background-color: transparent;
            color: white;
            border: 2px solid white;
        }

        .btn-outline:hover {
            background-color: white;
            color: var(--primary);
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        /* Authentication Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 40px;
            border-radius: 10px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.2);
            position: relative;
        }

        .close-modal {
            position: absolute;
            right: 15px;
            top: 15px;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        .close-modal:hover {
            color: var(--danger);
        }

        .modal h2 {
            color: var(--primary);
            margin-bottom: 25px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            transition: border 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(45, 91, 227, 0.1);
        }

        .switch-form {
            text-align: center;
            margin-top: 20px;
            font-size: 0.9rem;
        }

        .switch-form a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
        }

        .switch-form a:hover {
            text-decoration: underline;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 5px;
            color: white;
            font-weight: 600;
            z-index: 1002;
            transform: translateX(150%);
            transition: transform 0.3s ease-out;
            max-width: 300px;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast-success {
            background-color: var(--success);
        }

        .toast-error {
            background-color: var(--danger);
        }

        .toast-info {
            background-color: var(--primary);
        }

        /* Main Content */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
            margin-bottom: 40px;
        }

        .card {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
        }

        .card h2 {
            color: var(--primary);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card h2 i {
            color: var(--secondary);
        }

        /* Live Cab Tracking */
        #live-tracking {
            height: 400px;
            border-radius: 8px;
            margin-bottom: 20px;
            z-index: 1;
        }

        .cab-info {
            display: flex;
            align-items: center;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin-top: 15px;
        }

        .driver-photo {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #ddd;
            margin-right: 15px;
            overflow: hidden;
        }

        .driver-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .driver-details h4 {
            margin-bottom: 5px;
            color: #333;
        }

        .driver-details p {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .driver-rating {
            color: var(--secondary);
        }

        /* Booking History */
        .booking-item {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .booking-item:hover {
            border-color: var(--secondary);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .booking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .booking-status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-confirmed {
            background-color: #d4edda;
            color: #155724;
        }

        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-cancelled {
            background-color: #f8d7da;
            color: #721c24;
        }

        .status-ongoing {
            background-color: #cce5ff;
            color: #004085;
        }

        /* Budget & Payment */
        .budget-display {
            display: flex;
            justify-content: space-between;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 5px solid var(--secondary);
        }

        .budget-item {
            text-align: center;
        }

        .budget-item h3 {
            color: var(--primary);
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .budget-item p {
            color: #666;
            font-size: 0.9rem;
        }

        .payment-methods {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .payment-method {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .payment-method:hover, .payment-method.active {
            border-color: var(--primary);
            background-color: #eef5ff;
        }

        .payment-method i {
            font-size: 2rem;
            margin-bottom: 10px;
            color: var(--primary);
        }

        /* Real-time Updates */
        .live-update {
            background-color: #e8f4ff;
            border-left: 4px solid var(--primary);
            padding: 10px 15px;
            margin-bottom: 15px;
            border-radius: 0 5px 5px 0;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }

        /* Admin Dashboard */
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }

        .stat-card h3 {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .stat-card p {
            color: #666;
            font-size: 0.9rem;
        }

        /* Responsive Design */
        @media (max-width: 992px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .admin-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }
            
            nav ul {
                flex-wrap: wrap;
                justify-content: center;
                gap: 15px;
            }
            
            .payment-methods {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 576px) {
            .admin-stats {
                grid-template-columns: 1fr;
            }
            
            .budget-display {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Toast Notifications -->
    <div id="toast-container"></div>

    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('loginModal')">&times;</span>
            <h2><i class="fas fa-sign-in-alt"></i> Login</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email Address</label>
                    <input type="email" id="loginEmail" class="form-control" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" class="form-control" placeholder="Enter your password" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
            </form>
            <div class="switch-form">
                <p>Don't have an account? <a onclick="showRegisterModal()">Register here</a></p>
            </div>
        </div>
    </div>

    <!-- Register Modal -->
    <div id="registerModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('registerModal')">&times;</span>
            <h2><i class="fas fa-user-plus"></i> Register</h2>
            <form id="registerForm">
                <div class="form-group">
                    <label for="registerName">Full Name</label>
                    <input type="text" id="registerName" class="form-control" placeholder="Enter your full name" required>
                </div>
                <div class="form-group">
                    <label for="registerEmail">Email Address</label>
                    <input type="email" id="registerEmail" class="form-control" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label for="registerPhone">Phone Number</label>
                    <input type="tel" id="registerPhone" class="form-control" placeholder="Enter your phone number" required>
                </div>
                <div class="form-group">
                    <label for="registerPassword">Password</label>
                    <input type="password" id="registerPassword" class="form-control" placeholder="Create a password" required minlength="6">
                </div>
                <div class="form-group">
                    <label for="registerConfirmPassword">Confirm Password</label>
                    <input type="password" id="registerConfirmPassword" class="form-control" placeholder="Confirm your password" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-user-plus"></i> Create Account
                </button>
            </form>
            <div class="switch-form">
                <p>Already have an account? <a onclick="showLoginModal()">Login here</a></p>
            </div>
        </div>
    </div>

    <!-- Header Section -->
    <header>
        <div class="container header-content">
            <a href="#" class="logo">
                <i class="fas fa-route"></i>
                <span>TravelEase Pro</span>
            </a>
            <nav>
                <ul>
                    <li><a href="#home"><i class="fas fa-home"></i> Home</a></li>
                    <li><a href="#book"><i class="fas fa-taxi"></i> Book Cab</a></li>
                    <li><a href="#track"><i class="fas fa-map-marker-alt"></i> Live Tracking</a></li>
                    <li><a href="#bookings"><i class="fas fa-history"></i> My Bookings</a></li>
                    <li id="adminLink" style="display: none;"><a href="#admin"><i class="fas fa-cog"></i> Admin</a></li>
                </ul>
            </nav>
            <div class="user-actions">
                <div id="userGreeting" style="display: none;">
                    <span id="userName"></span>
                </div>
                <button id="authButton" class="btn btn-outline" onclick="showLoginModal()">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
                <button id="logoutButton" class="btn btn-danger" style="display: none;" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <div id="home">
            <!-- Welcome Section (Shown when logged in) -->
            <div id="welcomeSection" class="card" style="display: none; margin-top: 20px;">
                <h2><i class="fas fa-hand-wave"></i> Welcome, <span id="displayUserName"></span>!</h2>
                <div class="live-update">
                    <i class="fas fa-bell"></i> <strong>Live Update:</strong> Special offer: Get 20% off on your next booking!
                </div>
                <p>Ready to book your next trip? Use our smart booking system to find the best cabs and hotels.</p>
            </div>

            <!-- Cab Booking Section -->
            <div id="book" class="main-content">
                <div>
                    <div class="card">
                        <h2><i class="fas fa-taxi"></i> Book Your Cab</h2>
                        <div class="form-group">
                            <label for="pickup"><i class="fas fa-map-marker-alt"></i> Pickup Location</label>
                            <input type="text" id="pickup" class="form-control" placeholder="Enter pickup address">
                        </div>
                        <div class="form-group">
                            <label for="destination"><i class="fas fa-flag-checkered"></i> Destination</label>
                            <input type="text" id="destination" class="form-control" placeholder="Enter destination address">
                        </div>
                        <div class="form-group">
                            <label for="cabType">Cab Type</label>
                            <select id="cabType" class="form-control">
                                <option value="economy">Economy ($0.5/km)</option>
                                <option value="comfort">Comfort ($0.8/km)</option>
                                <option value="premium">Premium ($1.2/km)</option>
                                <option value="luxury">Luxury ($2.0/km)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="rideDate"><i class="fas fa-calendar-alt"></i> Travel Date</label>
                            <input type="date" id="rideDate" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="rideTime"><i class="fas fa-clock"></i> Pickup Time</label>
                            <input type="time" id="rideTime" class="form-control">
                        </div>
                        <button onclick="calculateFare()" class="btn btn-primary" style="width: 100%; margin-bottom: 15px;">
                            <i class="fas fa-calculator"></i> Calculate Fare
                        </button>
                        <button onclick="bookCab()" class="btn btn-success" style="width: 100%;" id="bookCabBtn" disabled>
                            <i class="fas fa-check-circle"></i> Confirm Booking
                        </button>
                    </div>

                    <!-- Budget Planning -->
                    <div class="card">
                        <h2><i class="fas fa-wallet"></i> Budget Planning</h2>
                        <div class="budget-display">
                            <div class="budget-item">
                                <h3 id="cabFare">$0</h3>
                                <p>Cab Fare</p>
                            </div>
                            <div class="budget-item">
                                <h3 id="hotelCost">$0</h3>
                                <p>Hotel Cost</p>
                            </div>
                            <div class="budget-item">
                                <h3 id="totalCost">$0</h3>
                                <p>Total</p>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="budgetLimit">Your Budget Limit ($)</label>
                            <input type="range" id="budgetLimit" class="form-control" min="20" max="500" value="100" oninput="updateBudgetLimit(this.value)">
                            <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                                <span>$20</span>
                                <span id="budgetValue">$100</span>
                                <span>$500</span>
                            </div>
                        </div>
                        <div id="budgetAlert" style="display: none; padding: 10px; background-color: #f8d7da; border-radius: 5px; margin-top: 10px;">
                            <i class="fas fa-exclamation-triangle"></i> Warning: Your booking exceeds budget limit!
                        </div>
                    </div>
                </div>

                <div>
                    <!-- Live Map Tracking -->
                    <div id="track" class="card">
                        <h2><i class="fas fa-map-marked-alt"></i> Live Cab Tracking</h2>
                        <div id="live-tracking"></div>
                        <div id="cabInfo" class="cab-info" style="display: none;">
                            <div class="driver-photo">
                                <img src="" alt="Driver Photo" id="driverPhoto">
                            </div>
                            <div class="driver-details">
                                <h4 id="driverName">Driver Name</h4>
                                <p><i class="fas fa-car"></i> <span id="cabModel">Toyota Camry</span> - <span id="cabNumber">ABC123</span></p>
                                <p><i class="fas fa-star driver-rating"></i> <span id="driverRating">4.8</span> | <span id="driverTrips">250+ trips</span></p>
                                <p><i class="fas fa-phone"></i> <span id="driverPhone">+1 234 567 8900</span></p>
                            </div>
                        </div>
                        <div id="noActiveRide" style="text-align: center; padding: 30px; color: #666;">
                            <i class="fas fa-taxi" style="font-size: 3rem; margin-bottom: 15px; color: #ddd;"></i>
                            <h3>No Active Ride</h3>
                            <p>Book a cab to see live tracking here</p>
                        </div>
                    </div>

                    <!-- Payment Section -->
                    <div class="card">
                        <h2><i class="fas fa-credit-card"></i> Payment</h2>
                        <div class="payment-methods">
                            <div class="payment-method" onclick="selectPayment('card')">
                                <i class="fas fa-credit-card"></i>
                                <p>Credit Card</p>
                            </div>
                            <div class="payment-method" onclick="selectPayment('paypal')">
                                <i class="fab fa-paypal"></i>
                                <p>PayPal</p>
                            </div>
                            <div class="payment-method" onclick="selectPayment('wallet')">
                                <i class="fas fa-wallet"></i>
                                <p>Wallet</p>
                            </div>
                        </div>
                        <div id="paymentDetails" style="display: none; margin-top: 20px;">
                            <div class="form-group">
                                <label id="paymentLabel">Card Number</label>
                                <input type="text" id="paymentInput" class="form-control" placeholder="Enter details">
                            </div>
                            <button onclick="processPayment()" class="btn btn-success" style="width: 100%;">
                                <i class="fas fa-lock"></i> Pay Now
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- My Bookings Section -->
        <div id="bookings" class="card" style="display: none;">
            <h2><i class="fas fa-history"></i> My Booking History</h2>
            <div id="bookingsList">
                <!-- Bookings will be loaded here dynamically -->
            </div>
        </div>

        <!-- Admin Dashboard (Only for admins) -->
        <div id="admin" class="card" style="display: none;">
            <h2><i class="fas fa-cog"></i> Admin Dashboard</h2>
            <div class="admin-stats">
                <div class="stat-card">
                    <h3 id="totalBookings">0</h3>
                    <p>Total Bookings</p>
                </div>
                <div class="stat-card">
                    <h3 id="activeDrivers">0</h3>
                    <p>Active Drivers</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalRevenue">$0</h3>
                    <p>Total Revenue</p>
                </div>
                <div class="stat-card">
                    <h3 id="pendingBookings">0</h3>
                    <p>Pending Bookings</p>
                </div>
            </div>
            <div id="adminControls">
                <!-- Admin controls will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer style="background-color: var(--dark); color: white; padding: 40px 0; margin-top: 40px;">
        <div class="container">
            <div style="text-align: center;">
                <h3 style="color: var(--secondary); margin-bottom: 20px;">TravelEase Pro</h3>
                <p>Complete Travel & Cab Booking Solution</p>
                <p style="margin-top: 20px; color: #aaa;">&copy; 2024 TravelEase Pro. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- External Libraries -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    
    <script>
        // API Configuration - Update with your domain
        const API_BASE_URL = 'https://your-domain.com/api'; // Change to your domain
        let map = null;
        let userMarker = null;
        let driverMarker = null;
        let user = null;
        let socket = null;
        let selectedPaymentMethod = null;
        let activeRide = null;

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthStatus();
            initMap();
            setupEventListeners();
            setupRealTimeUpdates();
        });

        // Check if user is already logged in
        async function checkAuthStatus() {
            const token = localStorage.getItem('token');
            if (token) {
                try {
                    const response = await fetch(`${API_BASE_URL}/auth/verify`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        user = data.user;
                        updateUIForUser();
                        loadUserBookings();
                        if (user.role === 'admin') {
                            loadAdminDashboard();
                        }
                    } else {
                        localStorage.removeItem('token');
                    }
                } catch (error) {
                    console.error('Auth check failed:', error);
                }
            }
        }

        // Initialize map
        function initMap() {
            map = L.map('live-tracking').setView([20.5937, 78.9629], 5); // Default to India
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            
            // Add user marker
            userMarker = L.marker([20.5937, 78.9629], {
                icon: L.divIcon({
                    className: 'user-marker',
                    html: '<div style="background-color: #2d5be3; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.5);"></div>',
                    iconSize: [26, 26]
                })
            }).addTo(map);
            
            userMarker.bindPopup("<b>Your Location</b>").openPopup();
        }

        // Setup event listeners
        function setupEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await loginUser();
            });
            
            // Register form
            document.getElementById('registerForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await registerUser();
            });
            
            // Auto-set date and time
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('rideDate').value = today;
            document.getElementById('rideDate').min = today;
            
            const now = new Date();
            const timeString = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            document.getElementById('rideTime').value = timeString;
            
            // Set up geolocation
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const { latitude, longitude } = position.coords;
                    map.setView([latitude, longitude], 13);
                    userMarker.setLatLng([latitude, longitude]);
                    
                    // Reverse geocode to get address (simulated)
                    document.getElementById('pickup').value = `Near ${latitude.toFixed(4)}, ${longitude.toFixed(4)}`;
                });
            }
        }

        // Setup real-time updates with Socket.io
        function setupRealTimeUpdates() {
            socket = io(API_BASE_URL, {
                auth: {
                    token: localStorage.getItem('token')
                }
            });
            
            socket.on('connect', () => {
                console.log('Connected to real-time server');
            });
            
            socket.on('rideUpdate', (data) => {
                if (data.userId === user?.id) {
                    updateRideStatus(data);
                }
            });
            
            socket.on('driverLocation', (data) => {
                if (data.rideId === activeRide?.id) {
                    updateDriverLocation(data.location);
                }
            });
            
            socket.on('adminUpdate', (data) => {
                if (user?.role === 'admin') {
                    updateAdminStats(data);
                }
            });
        }

        // User Authentication Functions
        async function loginUser() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    localStorage.setItem('token', data.token);
                    user = data.user;
                    showToast('Login successful!', 'success');
                    closeModal('loginModal');
                    updateUIForUser();
                    loadUserBookings();
                    
                    if (user.role === 'admin') {
                        loadAdminDashboard();
                    }
                } else {
                    showToast(data.message || 'Login failed', 'error');
                }
            } catch (error) {
                showToast('Network error. Please try again.', 'error');
            }
        }
        
        async function registerUser() {
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const phone = document.getElementById('registerPhone').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            
            if (password !== confirmPassword) {
                showToast('Passwords do not match!', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, email, phone, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showToast('Registration successful! Please login.', 'success');
                    showLoginModal();
                } else {
                    showToast(data.message || 'Registration failed', 'error');
                }
            } catch (error) {
                showToast('Network error. Please try again.', 'error');
            }
        }
        
        function logout() {
            localStorage.removeItem('token');
            user = null;
            document.getElementById('authButton').style.display = 'inline-flex';
            document.getElementById('logoutButton').style.display = 'none';
            document.getElementById('userGreeting').style.display = 'none';
            document.getElementById('welcomeSection').style.display = 'none';
            document.getElementById('bookings').style.display = 'none';
            document.getElementById('admin').style.display = 'none';
            document.getElementById('adminLink').style.display = 'none';
            showToast('Logged out successfully', 'info');
        }
        
        function updateUIForUser() {
            document.getElementById('authButton').style.display = 'none';
            document.getElementById('logoutButton').style.display = 'inline-flex';
            document.getElementById('userGreeting').style.display = 'inline-flex';
            document.getElementById('userName').textContent = user.name;
            document.getElementById('displayUserName').textContent = user.name;
            document.getElementById('welcomeSection').style.display = 'block';
            document.getElementById('bookings').style.display = 'block';
            
            if (user.role === 'admin') {
                document.getElementById('adminLink').style.display = 'block';
            }
        }

        // Cab Booking Functions
        async function calculateFare() {
            const pickup = document.getElementById('pickup').value;
            const destination = document.getElementById('destination').value;
            const cabType = document.getElementById('cabType').value;
            
            if (!pickup || !destination) {
                showToast('Please enter pickup and destination', 'error');
                return;
            }
            
            // Simulate fare calculation
            const rates = {
                'economy': 0.5,
                'comfort': 0.8,
                'premium': 1.2,
                'luxury': 2.0
            };
            
            const distance = Math.floor(Math.random() * 50) + 5; // Random distance 5-55 km
            const fare = (distance * rates[cabType]).toFixed(2);
            
            document.getElementById('cabFare').textContent = `$${fare}`;
            updateTotalCost();
            
            // Enable booking button
            document.getElementById('bookCabBtn').disabled = false;
            
            showToast(`Estimated fare: $${fare} for ${distance} km`, 'info');
        }
        
        async function bookCab() {
            const token = localStorage.getItem('token');
            if (!token) {
                showToast('Please login to book a cab', 'error');
                showLoginModal();
                return;
            }
            
            const bookingData = {
                pickup: document.getElementById('pickup').value,
                destination: document.getElementById('destination').value,
                cabType: document.getElementById('cabType').value,
                date: document.getElementById('rideDate').value,
                time: document.getElementById('rideTime').value,
                fare: parseFloat(document.getElementById('cabFare').textContent.replace('$', ''))
            };
            
            try {
                const response = await fetch(`${API_BASE_URL}/bookings`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(bookingData)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showToast('Cab booked successfully!', 'success');
                    document.getElementById('bookCabBtn').disabled = true;
                    loadUserBookings();
                    simulateDriverAssignment(data.booking);
                } else {
                    showToast(data.message || 'Booking failed', 'error');
                }
            } catch (error) {
                showToast('Network error. Please try again.', 'error');
            }
        }
        
        function simulateDriverAssignment(booking) {
            // Simulate driver assignment (in real app, this comes from backend)
            const drivers = [
                {
                    name: 'Rajesh Kumar',
                    photo: 'https://randomuser.me/api/portraits/men/32.jpg',
                    cabModel: 'Toyota Innova',
                    cabNumber: 'DL1CAB123',
                    rating: 4.8,
                    trips: 342,
                    phone: '+91 98765 43210'
                },
                {
                    name: 'Priya Sharma',
                    photo: 'https://randomuser.me/api/portraits/women/44.jpg',
                    cabModel: 'Maruti Suzuki Dzire',
                    cabNumber: 'DL1CAB456',
                    rating: 4.9,
                    trips: 289,
                    phone: '+91 98765 43211'
                },
                {
                    name: 'Amit Patel',
                    photo: 'https://randomuser.me/api/portraits/men/67.jpg',
                    cabModel: 'Hyundai Creta',
                    cabNumber: 'DL1CAB789',
                    rating: 4.7,
                    trips: 415,
                    phone: '+91 98765 43212'
                }
            ];
            
            const driver = drivers[Math.floor(Math.random() * drivers.length)];
            activeRide = {
                ...booking,
                driver,
                status: 'assigned',
                location: { lat: 28.7041, lng: 77.1025 } // Delhi coordinates
            };
            
            updateActiveRideDisplay();
        }
        
        function updateActiveRideDisplay() {
            if (activeRide) {
                document.getElementById('noActiveRide').style.display = 'none';
                document.getElementById('cabInfo').style.display = 'flex';
                
                document.getElementById('driverName').textContent = activeRide.driver.name;
                document.getElementById('driverPhoto').src = activeRide.driver.photo;
                document.getElementById('cabModel').textContent = activeRide.driver.cabModel;
                document.getElementById('cabNumber').textContent = activeRide.driver.cabNumber;
                document.getElementById('driverRating').textContent = activeRide.driver.rating;
                document.getElementById('driverTrips').textContent = `${activeRide.driver.trips}+ trips`;
                document.getElementById('driverPhone').textContent = activeRide.driver.phone;
                
                // Update driver marker on map
                if (driverMarker) {
                    map.removeLayer(driverMarker);
                }
                
                driverMarker = L.marker([activeRide.location.lat, activeRide.location.lng], {
                    icon: L.divIcon({
                        className: 'driver-marker',
                        html: '<div style="background-color: #ff9d00; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.5);"><i class="fas fa-taxi" style="color: white; font-size: 10px; position: absolute; top: 3px; left: 3px;"></i></div>',
                        iconSize: [26, 26]
                    })
                }).addTo(map);
                
                driverMarker.bindPopup(`<b>${activeRide.driver.name}</b><br>${activeRide.driver.cabModel}`).openPopup();
                
                // Start simulating driver movement
                simulateDriverMovement();
            }
        }
        
        function simulateDriverMovement() {
            if (!activeRide) return;
            
            const interval = setInterval(() => {
                if (activeRide && activeRide.status !== 'completed') {
                    // Simulate driver moving toward user
                    const userLatLng = userMarker.getLatLng();
                    const driverLat = activeRide.location.lat + (Math.random() - 0.5) * 0.01;
                    const driverLng = activeRide.location.lng + (Math.random() - 0.5) * 0.01;
                    
                    activeRide.location = { lat: driverLat, lng: driverLng };
                    driverMarker.setLatLng([driverLat, driverLng]);
                    
                    // If driver is close to user, complete ride
                    const distance = Math.sqrt(
                        Math.pow(driverLat - userLatLng.lat, 2) + 
                        Math.pow(driverLng - userLatLng.lng, 2)
                    ) * 111; // Convert to km
                    
                    if (distance < 0.1 && activeRide.status === 'assigned') { // 100 meters
                        activeRide.status = 'arrived';
                        showToast('Driver has arrived!', 'success');
                    }
                    
                    if (socket) {
                        socket.emit('driverLocation', {
                            rideId: activeRide.id,
                            location: activeRide.location
                        });
                    }
                } else {
                    clearInterval(interval);
                }
            }, 3000);
        }
        
        async function loadUserBookings() {
            const token = localStorage.getItem('token');
            if (!token) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/bookings/my`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const bookings = await response.json();
                    displayBookings(bookings);
                }
            } catch (error) {
                console.error('Failed to load bookings:', error);
            }
        }
        
        function displayBookings(bookings) {
            const container = document.getElementById('bookingsList');
            container.innerHTML = '';
            
            if (bookings.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 30px;">No bookings yet</p>';
                return;
            }
            
            bookings.forEach(booking => {
                const bookingElement = document.createElement('div');
                bookingElement.className = 'booking-item';
                bookingElement.innerHTML = `
                    <div class="booking-header">
                        <div>
                            <h3 style="color: var(--primary);">${booking.pickup} → ${booking.destination}</h3>
                            <p><i class="fas fa-calendar"></i> ${new Date(booking.date).toLocaleDateString()} at ${booking.time}</p>
                        </div>
                        <div>
                            <span class="booking-status status-${booking.status}">${booking.status.toUpperCase()}</span>
                            <h3 style="color: var(--success); margin-top: 5px;">$${booking.fare}</h3>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                        <div>
                            <p><i class="fas fa-taxi"></i> ${booking.cabType.charAt(0).toUpperCase() + booking.cabType.slice(1)} Cab</p>
                            ${booking.driver ? `<p><i class="fas fa-user"></i> ${booking.driver.name}</p>` : ''}
                        </div>
                        <div>
                            <button onclick="viewBookingDetails('${booking.id}')" class="btn btn-outline" style="border-color: var(--primary); color: var(--primary);">
                                <i class="fas fa-eye"></i> Details
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(bookingElement);
            });
        }

        // Payment Functions
        function selectPayment(method) {
            selectedPaymentMethod = method;
            
            // Remove active class from all
            document.querySelectorAll('.payment-method').forEach(el => {
                el.classList.remove('active');
            });
            
            // Add active class to selected
            event.target.closest('.payment-method').classList.add('active');
            
            // Show payment details
            document.getElementById('paymentDetails').style.display = 'block';
            
            switch(method) {
                case 'card':
                    document.getElementById('paymentLabel').textContent = 'Card Number';
                    document.getElementById('paymentInput').placeholder = '1234 5678 9012 3456';
                    break;
                case 'paypal':
                    document.getElementById('paymentLabel').textContent = 'PayPal Email';
                    document.getElementById('paymentInput').placeholder = 'email@example.com';
                    break;
                case 'wallet':
                    document.getElementById('paymentLabel').textContent = 'Wallet PIN';
                    document.getElementById('paymentInput').placeholder = 'Enter 6-digit PIN';
                    break;
            }
        }
        
        async function processPayment() {
            if (!selectedPaymentMethod) {
                showToast('Please select a payment method', 'error');
                return;
            }
            
            const paymentDetails = document.getElementById('paymentInput').value;
            if (!paymentDetails) {
                showToast('Please enter payment details', 'error');
                return;
            }
            
            // Simulate payment processing
            showToast('Processing payment...', 'info');
            
            setTimeout(() => {
                showToast('Payment successful!', 'success');
                document.getElementById('paymentDetails').style.display = 'none';
                document.querySelectorAll('.payment-method').forEach(el => {
                    el.classList.remove('active');
                });
                selectedPaymentMethod = null;
                
                if (activeRide) {
                    activeRide.status = 'completed';
                    showToast('Ride completed successfully!', 'success');
                    loadUserBookings();
                }
            }, 2000);
        }

        // Budget Functions
        function updateBudgetLimit(value) {
            document.getElementById('budgetValue').textContent = `$${value}`;
            updateTotalCost();
        }
        
        function updateTotalCost() {
            const cabFare = parseFloat(document.getElementById('cabFare').textContent.replace('$', '')) || 0;
            const hotelCost = parseFloat(document.getElementById('hotelCost').textContent.replace('$', '')) || 0;
            const total = cabFare + hotelCost;
            
            document.getElementById('totalCost').textContent = `$${total.toFixed(2)}`;
            
            const budgetLimit = parseInt(document.getElementById('budgetLimit').value);
            const budgetAlert = document.getElementById('budgetAlert');
            
            if (total > budgetLimit) {
                budgetAlert.style.display = 'block';
                document.getElementById('bookCabBtn').disabled = true;
            } else {
                budgetAlert.style.display = 'none';
                if (cabFare > 0) {
                    document.getElementById('bookCabBtn').disabled = false;
                }
            }
        }

        // Admin Functions
        async function loadAdminDashboard() {
            const token = localStorage.getItem('token');
            if (!token || user.role !== 'admin') return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/stats`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const stats = await response.json();
                    updateAdminStats(stats);
                }
                
                document.getElementById('admin').style.display = 'block';
            } catch (error) {
                console.error('Failed to load admin dashboard:', error);
            }
        }
        
        function updateAdminStats(stats) {
            document.getElementById('totalBookings').textContent = stats.totalBookings || 0;
            document.getElementById('activeDrivers').textContent = stats.activeDrivers || 0;
            document.getElementById('totalRevenue').textContent = `$${stats.totalRevenue || 0}`;
            document.getElementById('pendingBookings').textContent = stats.pendingBookings || 0;
        }

        // Utility Functions
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        function showLoginModal() {
            closeModal('registerModal');
            showModal('loginModal');
        }
        
        function showRegisterModal() {
            closeModal('loginModal');
            showModal('registerModal');
        }
        
        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            
            document.getElementById('toast-container').appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 3000);
        }
        
        function updateRideStatus(data) {
            showToast(`Ride status updated: ${data.status}`, 'info');
            loadUserBookings();
        }
        
        function updateDriverLocation(location) {
            if (driverMarker && activeRide) {
                driverMarker.setLatLng([location.lat, location.lng]);
            }
        }
        
        function viewBookingDetails(bookingId) {
            showToast(`Viewing details for booking ${bookingId}`, 'info');
            // In a real app, this would show a detailed modal
        }

        // Hotel booking simulation
        function simulateHotelBooking(hotelPrice) {
            document.getElementById('hotelCost').textContent = `$${hotelPrice}`;
            updateTotalCost();
            showToast(`Hotel added: $${hotelPrice}/night`, 'info');
        }

        // Simulate hotel selection
        setTimeout(() => {
            simulateHotelBooking(120);
        }, 1000);
    </script>
</body>
</html>